- name: Desplegar la página web en Docker con Apache y MySQL
  hosts: aws_instance
  become: true

  tasks:
    - name: Instalar Docker
      ansible.builtin.apt:
        name: docker.io
        state: present
        update_cache: true

    - name: Instalar Docker Compose
      ansible.builtin.apt:
        name: docker-compose
        state: present

    - name: Iniciar y habilitar Docker
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

    - name: Crear el directorio para Docker Compose
      ansible.builtin.file:
        path: /home/ubuntu/docker-website
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Crear archivo docker-compose.yml
      ansible.builtin.copy:
        dest: /home/ubuntu/docker-website/docker-compose.yml
        content: |
          version: '3'
          services:
            web:
              build: .
              container_name: php_apache_server
              volumes:
                - ./University:/var/www/html/
              ports:
                - "8080:80"
              depends_on:
                - db
            db:
              image: mysql:5.7
              container_name: mysql_db
              restart: always
              environment:
                MYSQL_ROOT_PASSWORD: rootpassword
                MYSQL_DATABASE: mydatabase
                MYSQL_USER: myuser
                MYSQL_PASSWORD: mypassword
              ports:
                - "3306:3306"
              volumes:
                - db_data:/var/lib/mysql
                - ./init.sql:/docker-entrypoint-initdb.d/init.sql
          volumes:
            db_data:
              driver: local
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Crear el Dockerfile
      ansible.builtin.copy:
        dest: /home/ubuntu/docker-website/Dockerfile
        content: |
          FROM php:8.1-apache
          RUN docker-php-ext-install mysqli && docker-php-ext-enable mysqli
          RUN a2enmod rewrite
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Copiar los archivos de la página web
      ansible.builtin.copy:
        src: /home/admon/Automatizacion/Ansible/University
        dest: /home/ubuntu/docker-website/University
        owner: ubuntu
        group: ubuntu
        mode: '0755'
        remote_src: no

    - name: Copiar el archivo init.sql
      ansible.builtin.copy:
        src: /home/admon/Automatizacion/Ansible/init.sql
        dest: /home/ubuntu/docker-website/init.sql
        owner: ubuntu
        group: ubuntu
        mode: '0644'
        remote_src: no

    - name: Comprobar si Docker Compose está en ejecución
      ansible.builtin.docker_compose:
        project_src: /home/ubuntu/docker-website
        state: present
      register: docker_compose_status
      ignore_errors: true

    - name: Iniciar los servicios con Docker Compose si no están en ejecución
      ansible.builtin.docker_compose:
        project_src: /home/ubuntu/docker-website
        state: present
      when: docker_compose_status.changed
